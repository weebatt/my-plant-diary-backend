# План реализации и журнал этапов

Документ описывает, что предстоит реализовать и что уже реализовано. После каждого этапа фиксируем подробный отчёт о недостатках и план исправлений. Цель — собрать надёжный базовый минимум без «выкрутасов», затем наращивать функциональность итеративно.

Сопутствующие документы:
- Архитектура: `ARCHITECTURE.md:1`
- Сообщения и топология RabbitMQ: `docs/messaging.md:1`

## Принципы
- Простота прежде всего: минимально достаточный функционал, явные границы сервисов.
- HTTP для синхронных вызовов; брокер (RabbitMQ) для асинхронных событий/команд.
- Данные принадлежат сервисам (PostgreSQL per‑service); интеграции через события и outbox.
- Роли: `user`, `admin`. Доступ на запись в словарь — только `admin`.

## Этапы (M0…)

### M0 — Фундамент
Цель: сервисы стабильно поднимаются локально, общие конвенции по брокеру и БД, health‑checks, минимальные хелперы.
- Deliverables
  - Объявления RabbitMQ: `x.events`, `x.commands`, `x.dlx`; очереди `q.<service>.*` + DLQ.
  - `infra/broker`: публикация/чтение `EventEnvelope` (JSON), headers, confirms/acks, prefetch.
  - Базовые Spring‑конфиги (AMQP, PostgreSQL), `/actuator/health` во всех сервисах.
  - Docker Compose: проверка доступности брокера и БД, переменные окружения.
- Критерии готовности
  - Все сервисы стартуют через Compose, health‑checks зелёные.
  - Топология создаётся на старте, сообщения проходят через тестовый publisher/consumer.
- Статус: В работе

### M1 — Пользователи и доступ
Цель: регистрация/аутентификация, роли, защищённые эндпоинты через `gateway`.
- Deliverables: `user-service` (модель пользователя, роль), простой auth (локальный JWT), `gateway` с охраной маршрутов.
- Критерии: авторизованный пользователь делает CRUD своих данных; роль `admin` присутствует в токене.
- Статус: Запланировано

### M2 — Словарь растений (админский)
Цель: CRUD растений, поиск, рекомендации по параметрам (RDF4J минимально), импорт/seed.
- Deliverables: `dictionary-service` (PostgreSQL + RDF4J), эндпоинт «рекомендации».
- Критерии: admin управляет словарём; рекомендации возвращаются по входным параметрам.
- Статус: Запланировано

### M3 — Дневник пользователя
Цель: учёт «моих растений», записи ухода, напоминания, события в брокер.
- Deliverables: `diary-service` CRUD, запрос рекомендаций к `dictionary-service`, outbox событий `diary.*.v1`.
- Критерии: пользователь ведёт дневник; события публикуются в `x.events`.
- Статус: Запланировано

### M4 — Календарь/Планировщик
Цель: синхронизация напоминаний → расписание, API календарных представлений.
- Deliverables: `scheduler` формирует слоты по `diary.reminder.*`, API для day/week/month.
- Критерии: изменения из дневника отражаются в календаре за секунды.
- Статус: Запланировано

### M5 — Наблюдаемость и качество
Цель: метрики, трейсы, алерты на DLQ, интеграционные тесты.
- Deliverables: Micrometer/OTel, Testcontainers (RabbitMQ, PostgreSQL), алерты/дашборды (минимум).
- Критерии: стабильные сборки, контролируемый DLQ.
- Статус: Запланировано

Отдельный поток после M4 (N‑серия): уведомления (Orchestrator, Telegram, WebPush), интеграция Avito.

## Журнал этапов

Шаблон отчёта по этапу (заполняется по завершении каждого Mx):
- Даты: старт → завершение
- Сделано:
  - Ключевые результаты (коротко)
  - Внесённые изменения (ссылки на модули/файлы)
- Недостатки/риски:
  - Технические (производительность, устойчивость, DX)
  - Продуктовые (пробелы UX, сценарии)
- Что исправить/улучшить:
  - Быстрые фиксы (следующий спринт)
  - Долгосрочные улучшения (бэклог)

### Журнал: M0 — Фундамент
- Статус: В работе
- Сделано: —
- Недостатки/риски: —
- Что исправить/улучшить: —

## Текущие задачи (M0)
- Объявить exchanges/queues/bindings по `docs/messaging.md` в одном сервисе (шаблон), затем тиражировать.
- Реализовать `infra/broker`: publisher/consumer helpers для `EventEnvelope` (JSON, headers, confirms, manual ack).
- Настроить `prefetch`, ручные подтверждения, политику DLQ.
- Добавить `/actuator/health` и базовые readiness/liveness во все сервисы.
- Проверить Compose: доступность RabbitMQ UI и БД, переменные окружения.

## Правила обновления документа
- После завершения этапа: заполнить раздел журнала по шаблону (ниже списка этапов).
- При изменении планов: корректировать цели/критерии и статусы этапов, фиксировать причины.
- Поддерживать ссылки на релевантные файлы (миграции, конфиги, контракты).
